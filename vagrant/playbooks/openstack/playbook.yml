---
###############################################################################
# This ansible playbook installs all supporting software necessary to run the
# OpenStack service locally into the vagrant VM attached. Its intent is to provide
# a quickstart development environment that doesn't pollute an engineer's own
# machine.
#
# The vagrant vm's IP address is assumed to be 192.168.99.11
- hosts: all
  gather_facts: no
  sudo: true
  vars_files:
      - vars.yml
  pre_tasks:
    - name: update apt cache
      apt: update_cache=yes

    # Make sure our VM's software is ~@Latest
    - name: Apt Update
      apt: update_cache=yes
          upgrade=dist
          cache_valid_time=86400

    - name: Adjusting Locale
      shell: locale-gen pt_BR.UTF-8

    - name: Check if packages need to be autoremoved
      command: apt-get --dry-run autoremove
      register: check_autoremove
      changed_when: False

    - name: Autoremove unused packages
      command: apt-get -y autoremove
      when: "'packages will be REMOVED' in check_autoremove.stdout"

    # Reboot if required.
    - name: Reboot system if required
      command: shutdown -r now 'Rebooting to complete system upgrade'
           removes=/var/run/reboot-required
      register: rebooted

    - name: Wait for VM Reboot.
      sudo: no
      local_action: wait_for
                    port=22
                    host="{{ ansible_default_ipv4.address }}"
                    search_regex=OpenSSH
                    delay=10
                    timeout=900
      when: rebooted.changed

    # Add OpenStack Repositories
    - name: Add OpenStack Repositories
      shell: sudo add-apt-repository -y cloud-archive:kilo

    - name: Update packages
      apt: update_cache=yes
           upgrade=dist
           cache_valid_time=86400

    - name: "Build hosts file"
      lineinfile: dest=/etc/hosts regexp='.*{{ item }}$' line="{{ hostvars[item].ansible_default_ipv4.address }} {{item}}" state=present
      when: hostvars[item].ansible_default_ipv4.address is defined
      with_items: groups['all']

  tasks:
       - include: tasks/common.yml
       - include: tasks/credentials.yml
###############################################################################
- hosts: controller
  sudo: true
  vars_files:
      - vars.yml
  handlers:
      - include: handlers/main.yml
  tasks:
      -  include: tasks/database-server.yml
      -  include: tasks/rabbitmq-server.yml
      -  include: tasks/keystone.yml
      -  include: tasks/nova-controller.yml
      -  include: tasks/glance.yml
      -  include: tasks/horizon.yml
      -  include: tasks/nfs-server.yml
      -  include: tasks/demo-project.yml

- hosts: compute_group
  sudo: true
  vars_files:
      - vars.yml
  tasks:
      -  include: tasks/nova-compute.yml
      -  include: tasks/nfs-client.yml
