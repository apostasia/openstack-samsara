---
- name: Install Keystone
- hosts: controller
  gather_facts: yes
  become: yes
  user: vagrant
  vars_files:
    - vars/main.yml
  handlers:
    - handlers/main.yml
  tasks:
    - name: Install Keystone packages
      apt: pkg={{ item }} state=present
      with_items:
          - keystone
          - python3-openstackclient
      tags:
        - keystone

    - name: Copy Keystone config file
      template:
          src: "keystone.conf.j2"
          dest: "/etc/keystone/keystone.conf"
          owner: root
          group: root
          mode: 0644
      tags:
        - keystone

    - name: Populate the Identity service database
      shell: /bin/sh -c "keystone-manage db_sync" keystone

    - name: Refs to Controller Node
      lineinfile:
          dest:  "/etc/apache2/apache2.conf"
          regexp: "^ServerName "
          line: "ServerName controller"
      notify: restart apache

    - name: Initialize Fernet key repositories
      shell:
        cmd: "{{ item }}"
      with_items:
        - keystone-manage fernet_setup --keystone-user keystone --keystone-group keystone
        - keystone-manage credential_setup --keystone-user keystone --keystone-group keystone
      
    - name: Bootstrap Identity service
      shell: keystone-manage bootstrap --bootstrap-password {{ openstack_users['admin_password'] }} --bootstrap-admin-url http://controller:5000/v3/ --bootstrap-internal-url http://controller:5000/v3/ --bootstrap-public-url http://controller:5000/v3/ --bootstrap-region-id RegionOne

    - name: Create Service Project
      environment: "{{ admin_env }}"
      command: openstack project create --domain default --description "Service Project" service
      ignore_errors: true

    - name: Create Samsara User
      environment: "{{ admin_env }}"
      command: openstack user create --domain default --password {{ openstack_users['samsara_password'] }} samsara
      register: create_samsara_user
      ignore_errors: true

    - name: Create Samsara Demo Project
      environment: "{{ admin_env }}"
      command: openstack project create --domain default --description "Demo Project" samsaraproject
      when: create_samsara_user is succeeded

    - name: Create Samsara Role
      environment: "{{ admin_env }}"
      command: openstack role create samsararole
      when: create_samsara_user is succeeded

    - name: Add Samsara Role to Samsara User
      environment: "{{ admin_env }}"
      command: openstack role add --project samsaraproject --user samsara samsararole
      when: create_samsara_user is succeeded
